name: Deploy Susanoo

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd /workspace/hashirama-chat-susanoo
            git pull origin main

            # Install dependencies if needed
            npm install --production=false

            # Build TypeScript
            npm run build

            # Restart the service
            if systemctl is-enabled hashirama-chat &>/dev/null; then
              systemctl restart hashirama-chat
            else
              # Fallback: kill + restart manually
              lsof -ti:8090 | xargs kill -9 2>/dev/null || true
              pkill -f "/workspace/hashirama-chat-susanoo.*server.js" || true
              sleep 2
              cd /workspace/hashirama-chat-susanoo
              set -a; source .env 2>/dev/null; set +a
              PORT=8090 nohup node dist/server.js > /var/log/susanoo.log 2>&1 &
            fi

            # Wait for server to start and verify
            echo "Waiting for server to start..."
            sleep 3
            if curl -sf http://localhost:8090/api/health > /dev/null; then
              echo "✓ Deploy OK - Server is running"
              curl -s http://localhost:8090/api/health | grep -o '"version":"[^"]*"'
            else
              echo "✗ Deploy FAILED - Server health check failed"
              tail -20 /var/log/susanoo.log
              exit 1
            fi
